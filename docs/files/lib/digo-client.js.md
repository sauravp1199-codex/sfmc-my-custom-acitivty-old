# `lib/digo-client.js`

## Role in the System
Handles outbound HTTP communication with the DIGO SMS provider, adding retry logic, configurable headers, and stub mode for testing.

## Public API

| Export | Description |
| --- | --- |
| `sendPayloadWithRetry(payload, options)` | Sends the payload to the DIGO API with exponential backoff and optional overrides. |
| `ProviderRequestError` | Custom `Error` class thrown when the provider request fails or returns an unexpected status. |
| `getConfig()` | Reads environment configuration used by the client (URL, credentials, retry settings). |

## Key Parameters and Return Types

* `payload` – Object generated by `buildDigoPayload`.
* `options` – Optional overrides:
  * `retryAttempts`, `retryBackoffMs` – Numeric overrides for retry behavior.
  * `httpClient` – Injectable HTTP client (defaults to `axios`).
  * `headers` – Additional headers merged with defaults.
* Returns an Axios-like response `{ status, data }` on success.
* Throws `ProviderRequestError` containing `statusCode` and `details` when all retries fail.

## External Dependencies

* `axios` for HTTP requests (can be replaced via `options.httpClient`).
* `./logger` for trace logging.
* Environment variables read by `getConfig()`:
  * `DIGO_API_URL` – Provider endpoint (default `https://sfmc.comsensetechnologies.com/api/message`).
  * `COMSENSE_BASIC_AUTH` – Base64 `username:password` credential applied to the `Authorization` header.
  * `DIGO_HTTP_TIMEOUT_MS` – Request timeout in milliseconds (default `15000`).
  * `DIGO_RETRY_ATTEMPTS` – Number of retries (default `3`).
  * `DIGO_RETRY_BACKOFF_MS` – Initial backoff (default `500` ms, exponential).
  * `DIGO_STUB_MODE` – When `'true'`, bypasses HTTP calls and returns a stub response.

## Data Flow

1. `sendPayloadWithRetry` reads configuration via `getConfig()` and merges caller overrides.
2. Builds headers with authorization tokens and merges additional headers.
3. If stub mode is enabled, logs and returns a canned success response containing the payload.
4. Otherwise, attempts the HTTP POST up to `retryAttempts` times with exponential backoff on retryable failures (network issues or 5xx responses).
5. Logs each attempt, success, and failure for correlation.

## Error Handling and Edge Cases

* Non-2xx responses create a `ProviderRequestError` including response body and status for diagnostics.
* Network errors record `error.response` data when available; decision to retry is based on missing status or 5xx.
* Backoff doubles each attempt (`waitMs = backoffMs * 2^(attempt-1)`).
* Stub mode prevents accidental provider calls during local development or automated tests.

## Usage Example

```js
const { sendPayloadWithRetry } = require('./lib/digo-client');

try {
  const response = await sendPayloadWithRetry(payload, {
    headers: { 'X-Correlation-Id': correlationId }
  });
  console.log(response.data);
} catch (error) {
  if (error instanceof ProviderRequestError) {
    // surface details to Journey Builder and log for support
  }
}
```

## Related Files

* Called by `/executeV2` in `app.js` to deliver DIGO payloads.
* Consumes payloads built in `lib/digo-payload.js`.
* Logging relies on `lib/logger.js`.

## Troubleshooting

* **Stub mode always active** – Ensure `DIGO_STUB_MODE` is unset or set to `'false'` in production environments.
* **Persistent provider failures** – Review log entries for `ProviderRequestError` details, verify credentials, and confirm network access to `DIGO_API_URL`.
* **Slow responses** – Adjust `DIGO_HTTP_TIMEOUT_MS`, `DIGO_RETRY_ATTEMPTS`, and `DIGO_RETRY_BACKOFF_MS` to balance resilience and latency.

## Glossary

* **Stub Mode** – Development feature that simulates provider responses without performing real API calls.
* **Exponential Backoff** – Retry strategy that increases wait time between attempts to reduce load on external services.
